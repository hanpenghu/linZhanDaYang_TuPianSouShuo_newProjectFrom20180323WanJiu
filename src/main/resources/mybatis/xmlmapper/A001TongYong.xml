<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.winwin.picreport.Ddao.reportxmlmapper.A001TongYongMapper">
    <!--<resultMap id="BaseResultMap" type=""></resultMap>-->
    <!-- 可以继承另一个名称空间的东西-->
    <resultMap id="PrdtSampBaseResultMap"
               extends="com.winwin.picreport.Ddao.reportxmlmapper.PrdtSampMapper.BaseResultMap"
               type="com.winwin.picreport.Edto.PrdtSamp0">
    </resultMap>


    <!--添加查询模块给所有返回信息
    //    //销售价格列表
//    List<UpDefMy>upDefMyListSale=new ArrayList<>();
//    //采购价格列表
//    List<UpDefMy>upDefMyListByer=new ArrayList<>();
    -->


    <!--    <resultMap id="UpDefMyBaseResultMap" type="com.winwin.picreport.Edto.UpDefMy01">
            <id column="CUR_ID" jdbcType="VARCHAR" property="curId" />
            <id column="QTY" jdbcType="NUMERIC" property="qty" />
            <id column="S_DD" jdbcType="TIMESTAMP" property="sDd" />
            <result column="UP" jdbcType="NUMERIC" property="up" />
            <result column="UNIT" jdbcType="VARCHAR" property="unit" />
            <result column="name" jdbcType="VARCHAR" property="curName" />
            <result column="bil_type" jdbcType="VARCHAR" property="bilType" />
            <result column="price_id" jdbcType="VARCHAR" property="priceId" />
            <result column="rem" jdbcType="VARCHAR" property="remOfPrdtSampOs" />
           &lt;!&ndash; <result column="ut" jdbcType="VARCHAR" property="unit" />&ndash;&gt;
        </resultMap>-->
    <!-- <sql id="PrdtSampBase_Column_List">
         id, prd_code, idx_name, idx_no, mark_name, mark_no, colour, size, sal_name, sal_no,
         cus_no, cus_name, isFenJie, samp_make, samp_send, samp_requ, samp_desc, thum, attach,
         insertdate, confirmMan, confirmTimeStr, isConfirm, Category, TeamName, confirmRem,
         unit, businessDesc, financeDesc, startSellCount, modelCost, estimatePrice, littleOrderPrice
     </sql>-->
    <!-- 产品打样列表多条件查询的条件-->


    <!--<sql id="productProofWithManyCondition">-->


        <!--(-->

        <!--insertDate-->
        <!--BETWEEN-->
        <!--<choose>-->
            <!--<when test="insertdateStr != null and insertdateStr != ''">-->
                <!--#{insertdateStr}-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--'1970-01-01'-->
            <!--</otherwise>-->
        <!--</choose>-->
        <!--AND-->
        <!--<choose>-->
            <!--<when test="insertdateStrEnd != null and insertdateStrEnd != ''">-->
                <!--#{insertdateStrEnd}-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--'9999-01-01'-->
            <!--</otherwise>-->
        <!--</choose>-->
        <!--)-->

        <!--AND-->
        <!--&#45;&#45; 产品名称,大范围-->
        <!--isnull(idx_Name,'') LIKE-->
        <!--<choose>-->
            <!--<when test="idxName != null and idxName != ''">-->
                <!--('%' + (#{idxName}) + '%')-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--isnull(idx_Name,'')-->
            <!--</otherwise>-->
        <!--</choose>-->
        <!--AND-->
        <!-- -&#45;&#45;  产品分类 小范围-->
        <!--isnull(fen_lei_name,'') LIKE-->
        <!--<choose>-->
            <!--<when test=" fenLeiName != null and fenLeiName != '' ">-->
                <!--('%'+( #{fenLeiName})+ '%')-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--isnull(fen_lei_name,'')-->
            <!--</otherwise>-->
        <!--</choose>-->
        <!--AND-->
        <!--&#45;&#45;产品编码-->
        <!--isnull(prd_Code,'') LIKE-->
        <!--<choose>-->
            <!--<when test=" prdCode != null and prdCode != '' ">-->
                <!--('%'+( #{prdCode}) +'%')-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--isnull(prd_Code,'')-->
            <!--</otherwise>-->
        <!--</choose>-->

        <!--AND-->
        <!--&#45;&#45;产品负责人,模糊查询-->
        <!--isnull(sal_name,'') LIKE-->
        <!--<choose>-->
            <!--<when test="salName != null and salName != '' ">-->
                <!--('%' +( #{salName}) + '%')-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--isnull(sal_name,'')-->
            <!--</otherwise>-->
        <!--</choose>-->
        <!--AND-->
        <!--&#45;&#45;是否已经打样确认，1是确认 0是未确认 ""确认+未确认-->
        <!--isnull(isConfirm,9)=-->
        <!--<choose>-->
            <!--<when test=" isconfirm != null">-->
                <!--#{isconfirm}-->
            <!--</when>-->
            <!--<otherwise>-->
                <!--isnull(isConfirm,9)-->
            <!--</otherwise>-->
        <!--</choose>-->

        <!--<if test="confirmtimestr != null and confirmtimestr != ''">-->
            <!--<![CDATA[ AND confirmTimeStr >=  #{confirmtimestr}  ]]>-->
        <!--</if>-->
        <!--<if test="confirmtimestrEnd != null and confirmtimestrEnd != ''">-->
            <!--<![CDATA[ AND confirmTimeStr <=  #{confirmtimestrEnd}  ]]>-->
        <!--</if>-->
    <!--</sql>-->

    <sql id="productProofWithManyCondition">
        id=id
        <if test=" insertdateStr != null and insertdateStr != '' ">
            <![CDATA[  AND  insertDate >= #{insertdateStr}  ]]>
        </if>
        <if test=" insertdateStrEnd != null and insertdateStrEnd != '' ">
            <![CDATA[  AND  insertDate <= #{insertdateStrEnd}  ]]>
        </if>
        <if test=" idxName != null and idxName != '' ">
             AND  isnull(idx_Name,'') LIKE ('%' + (#{idxName}) + '%')   -- 大范围
        </if>
        <if test=" fenLeiName != null and fenLeiName != '' ">
            AND  isnull(fen_lei_name,'') LIKE ('%'+( #{fenLeiName})+ '%')  --  小范围
        </if>
        <if test=" prdCode != null and prdCode != '' ">
            AND  isnull(prd_Code,'') LIKE ('%'+( #{prdCode}) +'%')
        </if>
        <if test=" salName != null and salName != '' ">
            AND  isnull(sal_name,'') LIKE ('%'+( #{salName}) +'%')
        </if>
        <if test=" isconfirm != null and isconfirm != '' ">
            AND  isnull(isConfirm,'') =  #{isconfirm}   -- 是否已经打样确认，1是确认 0是未确认 ""确认+未确认
        </if>
        <if test="confirmtimestr != null and confirmtimestr != ''">
            <![CDATA[ AND convert(datetime,confirmtimestr) >=  #{confirmtimestr}  ]]>
        </if>
        <if test="confirmtimestrEnd != null and confirmtimestrEnd != ''">
            <![CDATA[ AND convert(datetime,confirmtimestr) <=  #{confirmtimestrEnd}  ]]>
        </if>
        <if test=" isCheckOut != null and isCheckOut  != '' ">
            <![CDATA[ AND is_Check_Out LIKE  #{ isCheckOut }  ]]>
        </if>

        <if test=" cusName != null and cusName  != '' ">
            <![CDATA[ AND cus_Name LIKE  #{ cusName }  ]]>
        </if>

    </sql>









    <!--登录验证用的  得到修改跟人信息接口 -->
    <select id="selectUserEditInfo" resultType="com.winwin.picreport.Edto.LoginInfo">
          Select
            u.tenantid AS 'tenantId'
            ,u.userEmail AS 'userEmail'
            ,u.userPswd AS 'userPswd'
            ,u.phone_no AS 'phoneNo'
            ,u.user_name AS 'userName'
            ,t.tenantName AS 'tenantName'
            from   users u,tenant t where t.tenantid=u.tenantid
            ---下一句话的意思是: 至少有一个不是space或者null
            and (isnull(u.userEmail,'')!='' or   isnull(u.phone_no,'')!='' or  isnull(u.user_name,'')!='')
            and isnull(u.tenantid,'')=#{info.tenantId}
            and isnull(t.tenantid,'')=#{info.tenantId}
            and
            (
                isnull(u.userEmail,'')=#{info.userEmail}
                or isnull(u.phone_no,'')=#{info.phoneNo}
                or isnull(u.user_name,'')=#{info.userName}
            )

    </select>


    <!-- 修改个人信息用的sql -->
    <update id="updateUserInfo" parameterType="com.winwin.picreport.Edto.LoginInfo">
        UPDATE USERS
        SET
        <if test="newUserEamil != null and newUserEamil !='' and newUserEamil != 'undefined' ">
            userEmail=#{newUserEamil},
        </if>
        <if test="newUserPswd != null and newUserPswd !='' and newUserPswd != 'undefined' ">
            userPswd=#{newUserPswd},
        </if>
        <if test="newPhoneNo != null and newPhoneNo !='' and newPhoneNo != 'undefined' ">
            phone_no=#{newPhoneNo},
        </if>
        <if test="newUserName != 'undefined' and newUserName != null and newUserName !='' ">
            user_name=#{newUserName}, ---注意,这里有undifined的时候,会正题插不进去,因为这一行不要了,上面一行多了个逗号跟where搞在一起了
        </if>
        timetoken=timetoken ---这个主要是解决最后一个if是null的时候报错的问题
        where
        ---下一句话的意思是: 至少有一个不是space或者null
        (isnull(userEmail,'')!='' or isnull(phone_no,'')!='' or isnull(user_name,'')!='')
        and isnull(tenantid,'')=#{tenantId}
        and
        (
        isnull(userEmail,'')=#{userEmail}
        or isnull(phone_no,'')=#{phoneNo}
        or isnull(user_name,'')=#{userName}
        )
    </update>


    <!-- 产品打样列表多条件查询-->
    <select id="chanPinBianMaJianDangTiaoJianChaXun" resultMap="PrdtSampBaseResultMap">
        SELECT
        TOP
        (#{meiYeXianShiShu})
        <include refid="com.winwin.picreport.Ddao.reportxmlmapper.PrdtSampMapper.Base_Column_List"/>
        FROM
        PRDT_SAMP
        WHERE
        id NOT IN
        (
            select top
                (
                    (#{meiYeXianShiShu})*((#{dangQianYe})-1)
                )id from PRDT_SAMP
            WHERE
            <!-- 产品打样列表多条件查询的条件-->
            <include refid="productProofWithManyCondition"/>
            ORDER BY insertdate DESC
        )
            AND
            <!-- 产品打样列表多条件查询的条件-->
            <include refid="productProofWithManyCondition"/>
        ORDER BY insertdate DESC
    </select>


    <!--林展多条件查询接口 -->

    <select id="getCountOfDuoTiaoJianChaXunZongJiLuShu" resultType="java.lang.Integer">
        SELECT count(id)
        FROM PRDT_SAMP
        WHERE
        <!-- 产品打样列表多条件查询的条件-->
        <include refid="productProofWithManyCondition"/>
    </select>

<!-- =================================================================================================================== -->

    <!-- 产品打样列表多条件查询导出excel-->
    <select id="chanPinBianMaJianDangTiaoJianChaXunExportExcel" resultType="com.winwin.picreport.Edto.PrdtSampExcleExportManyCondition">
        SELECT
        TOP
        (#{meiYeXianShiShu})
        <include refid="column_ListOfExportExcel"/>
        FROM
        PRDT_SAMP p
        <include refid="leftJoinOfExportExcel"/>
        WHERE
        p.id NOT IN
        (
                  select top
                (
                  (#{meiYeXianShiShu})*((#{dangQianYe})-1)
                )p1.id from PRDT_SAMP p1
                <include refid="leftJoinOfExportExcel1"/>
                WHERE
                <!-- 产品打样列表多条件查询的条件-->
                 <include refid="exportExcelManyCondition1"/>
                 ORDER BY p1.insertdate DESC
        )
        AND
        <!-- 产品打样列表多条件查询的条件-->
        <include refid="exportExcelManyCondition"/>
        ORDER BY p.insertdate DESC
    </select>




    <sql id="leftJoinOfExportExcel">
        left join up_def u1 on p.prd_no=u1.prd_no and u1.price_id='1' and u1.cur_id='RMB' and u1.bil_type='2' -- 2是有运费
        left join up_def u2 on p.prd_no=u2.prd_no and u2.price_id='1' and u2.cur_id='RMB' and u2.bil_type='1' and u2.olefield=u1.olefield
        left join up_def u3 on p.prd_no=u3.prd_no and u3.price_id='1' and u3.cur_id='USD' and u3.bil_type='2' and u3.olefield=u2.olefield
        left join up_def u4 on p.prd_no=u4.prd_no and u4.price_id='1' and u4.cur_id='USD' and u4.bil_type='1' and u4.olefield=u3.olefield
        -- left join up_def u5 on p.prd_no=u5.prd_no and u5.price_id='2' and u5.cur_id='RMB' and u5.bil_type='1' and u5.prm_no=u4.prm_no -- 无运费
        -- left join up_def u6 on p.prd_no=u6.prd_no and u6.price_id='2' and u6.cur_id='RMB' and u6.bil_type='' and u6.olefield=u5.olefield -- 有运费
    </sql>

    <sql id="exportExcelManyCondition">
           p.id=p.id
        <if test=" insertdateStr != null and insertdateStr != '' ">
            <![CDATA[  AND  p.insertDate >= #{insertdateStr}  ]]>
        </if>
        <if test=" insertdateStrEnd != null and insertdateStrEnd != '' ">
            <![CDATA[  AND  p.insertDate <= #{insertdateStrEnd}  ]]>
        </if>
        <if test=" idxName != null and idxName != '' ">
            AND  isnull(p.idx_Name,'') LIKE ('%' + (#{idxName}) + '%')   -- 大范围
        </if>
        <!--<if test=" fenLeiName != null and fenLeiName != '' ">-->
            <!--AND  isnull(p.fen_lei_name,'') LIKE ('%'+( #{fenLeiName})+ '%')  &#45;&#45;  小范围-->
        <!--</if>-->
        <if test=" fenLeiNames !=null and fenLeiNames.size()>0 ">
            and p.fen_lei_name  in
            <foreach item="item" index="index" collection="fenLeiNames" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test=" prdCode != null and prdCode != '' ">
            AND  isnull(p.prd_Code,'') LIKE ('%'+( #{prdCode}) +'%')
        </if>
        <if test=" salName != null and salName != '' ">
            AND  isnull(p.sal_name,'') LIKE ('%'+( #{salName}) +'%')
        </if>
        <if test=" isconfirm != null and isconfirm != '' ">
            AND  isnull(p.isConfirm,'') =  #{isconfirm}   -- 是否已经打样确认，1是确认 0是未确认 ""确认+未确认
        </if>
        <if test="confirmtimestr != null and confirmtimestr != ''">
            <![CDATA[ AND convert(datetime,p.confirmtimestr) >=  #{confirmtimestr}  ]]>
        </if>
        <if test="confirmtimestrEnd != null and confirmtimestrEnd != ''">
            <![CDATA[ AND convert(datetime,p.confirmtimestr) <=  #{confirmtimestrEnd}  ]]>
        </if>
        <if test=" isCheckOut != null and isCheckOut  != '' ">
            <![CDATA[ AND p.is_Check_Out LIKE  #{ isCheckOut }  ]]>
        </if>
        <if test=" cusName != null and cusName  != '' ">
            <![CDATA[ AND p.cus_name LIKE  #{ cusName }  ]]>
        </if>
    </sql>




    <sql id="leftJoinOfExportExcel1">
        left join up_def u11 on p1.prd_no=u11.prd_no and u11.price_id='1' and u11.cur_id='RMB' and u11.bil_type='2' -- 2是有运费
        left join up_def u22 on p1.prd_no=u22.prd_no and u22.price_id='1' and u22.cur_id='RMB' and u22.bil_type='1' and u22.olefield=u11.olefield
        left join up_def u33 on p1.prd_no=u33.prd_no and u33.price_id='1' and u33.cur_id='USD' and u33.bil_type='2' and u33.olefield=u22.olefield
        left join up_def u44 on p1.prd_no=u44.prd_no and u44.price_id='1' and u44.cur_id='USD' and u44.bil_type='1' and u44.olefield=u33.olefield
        -- left join up_def u55 on p.prd_no=u55.prd_no and u55.price_id='2' and u55.cur_id='RMB' and u55.bil_type='1' and u55.prm_no=u44.prm_no -- 无运费
        -- left join up_def u66 on p.prd_no=u66.prd_no and u66.price_id='2' and u66.cur_id='RMB' and u66.bil_type='' and u66.olefield=u55.olefield -- 有运费
    </sql>

    <sql id="exportExcelManyCondition1">
        p1.id=p1.id
        <if test=" insertdateStr != null and insertdateStr != '' ">
            <![CDATA[  AND  p1.insertDate >= #{insertdateStr}  ]]>
        </if>
        <if test=" insertdateStrEnd != null and insertdateStrEnd != '' ">
            <![CDATA[  AND  p1.insertDate <= #{insertdateStrEnd}  ]]>
        </if>
        <if test=" idxName != null and idxName != '' ">
            AND  isnull(p1.idx_Name,'') LIKE ('%' + (#{idxName}) + '%')   -- 大范围
        </if>
        <!--<if test=" fenLeiName != null and fenLeiName != '' ">-->
            <!--AND  isnull(p1.fen_lei_name,'') LIKE ('%'+( #{fenLeiName})+ '%')  &#45;&#45;  小范围-->
        <!--</if>-->
        <if test=" fenLeiNames !=null and fenLeiNames.size()>0 ">
            and p1.fen_lei_name  IN
            <foreach item="item" index="index" collection="fenLeiNames" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test=" prdCode != null and prdCode != '' ">
            AND  isnull(p1.prd_Code,'') LIKE ('%'+( #{prdCode}) +'%')
        </if>
        <if test=" salName != null and salName != '' ">
            AND  isnull(p1.sal_name,'') LIKE ('%'+( #{salName}) +'%')
        </if>
        <if test=" isconfirm != null and isconfirm != '' ">
            AND  isnull(p1.isConfirm,'') =  #{isconfirm}   -- 是否已经打样确认，1是确认 0是未确认 ""确认+未确认
        </if>
        <if test="confirmtimestr != null and confirmtimestr != ''">
            <![CDATA[ AND convert(datetime,p1.confirmtimestr) >=  #{confirmtimestr}  ]]>
        </if>
        <if test="confirmtimestrEnd != null and confirmtimestrEnd != ''">
            <![CDATA[ AND convert(datetime,p1.confirmtimestr) <=  #{confirmtimestrEnd}  ]]>
        </if>
        <if test=" isCheckOut != null and isCheckOut  != '' ">
            <![CDATA[ AND p1.is_Check_Out LIKE  #{ isCheckOut }  ]]>
        </if>
        <if test=" cusName != null and cusName  != '' ">
            <![CDATA[ AND p1.cus_name LIKE  #{ cusName }  ]]>
        </if>
    </sql>

    <sql id="column_ListOfExportExcel">
          isnull(p.id,'')as id,
            isnull(p.prd_code,'') as prdCode,
            isnull(p.idx_Name,'') as idxName,
             isnull(p.idx_no,'') as idxNo,
             isnull(p.fen_Lei_No,'') as fenLeiNo,
            isnull(p.fen_Lei_Name,'') as fenLeiName,
             isnull(p.mark_Name,'') as markName,
            isnull(p.mark_No,'') as markNo,
             isnull(p.colour,'')as colour,
             isnull(p.size,'')as size,
             isnull(p.sal_Name,'') as salName,
             isnull(p.sal_No,'') as salNo,
             isnull(p.cus_No,'') as cusNo,
             isnull(p.cus_Name,'') as cusName,
             isnull(p.cus_No_Give,'') as cusNoGive,
             isnull(p.cus_Name_Give,'') as cusNameGive,
             isnull(p.isfenjie,'')as isfenjie,
             isnull(convert(varchar(100),p.samp_Make,121),'') as sampMake,
             isnull(convert(varchar(100),p.samp_Send,121),'') as sampSend,
             isnull(p.samp_Requ,'') as sampRequ,
             isnull(p.samp_Desc,'') as sampDesc,
             isnull(p.thum,'')as thum,
             isnull(p.attach,'')as attach,
             isnull(convert(varchar(100),p.insertdate,121),'')as insertdate,
             isnull(p.confirmman,'')as confirmman,
             isnull(p.confirmtimestr,'')as confirmtimestr,
             isnull(convert(varchar(10),p.isconfirm),'0')as isconfirm,
             isnull(p.category,'')as category,
             isnull(p.teamname,'')as teamname,
             isnull(p.confirmrem,'')as confirmrem,
             isnull(p.unit,'')as unit,
             isnull(p.businessdesc,'')as businessdesc,--//业务描述
             isnull(p.financedesc,'')as financedesc,--//财务描述
            --//        private BigDecimal startsellcount,//采购起订数量//json可以直接转换输出给外部//起订量
             isnull(convert(varchar(23),convert(decimal(23,4),p.startsellcount)),'')as startsellcount,
            --//        private BigDecimal modelcost,//模具费
            isnull(convert(varchar(23),convert(decimal(23,4),p.modelcost)),'') as modelcost,--//模具费
           -- //        private BigDecimal estimateprice,//预估价
            isnull(convert(varchar(23),convert(decimal(23,4),p.estimateprice)),'')as estimateprice,--//预估价
            --//        private BigDecimal littleorderprice,//小单费
             isnull(convert(varchar(23),convert(decimal(23,4),p.littleorderprice)),'')as littleorderprice,--//小单费
             isnull(p.modelcostinvoiceno,'')as modelcostinvoiceno,--//模具费用发票号
           -- //财务起订量
             isnull(convert(varchar(23),convert(decimal(23,4),p.financestartsellcount)),'')as financestartsellcount,
           -- //财务模具费
             isnull(convert(varchar(23),convert(decimal(23,4),p.financemodelcost)),'')as financemodelcost,
            --//财务小单费
             isnull(convert(varchar(23),convert(decimal(23,4),p.financelittleorderprice)),'')as financelittleorderprice,
           -- //采购描述
             isnull(p.buyerdesc,'')as buyerdesc,
            --//货号
             isnull(p.prd_No,'') as prdNo,
            --//销售描述
            isnull(p.salemandesc,'')as salemandesc,
            --//    /停用时间/
             isnull(convert(varchar(23),p.stopusedate),'')as stopusedate,
            --//创建人的userName,实际上我传给徐勇的放在userEmail字段了
             isnull(p.user_Name,'') as userName,
            --//创建人所在的公司,
             isnull(p.tenant_Id,'') as tenantId,
            --//是否审核   0或者null或者''代表未提交,  1代表已经提交但未审核,  2代表已经审核过
            --//    有状态: 0、未提交,1、已经提交但是未审核等待审核,2、已经提交已审核
            --//-- ---2018_6_19   weekday(2)   12:08:01---  添加一个是否提交并审核字段该字段 is_check_out 有状态:
            --//            -- 0(或者null或者'')、未提交,
            --//            --  1、已经提交但是未审核等待审核,2、已经提交已审核  ---------- --
           -- //            --    提交的前提是: 必须有： 供应商(cus_No_Give,cus_Name_Give),起订量(startsellcount),小单费(littleorderprice) 和 已经进行过采购定价
             isnull(p.is_Check_Out,'0') as isCheckOut,
            --//审核意见
             isnull(p.check_Out_Opinion,'') as checkOutOpinion,
           -- //起订金额
             isnull(convert(varchar(23),convert(decimal(23,4),p.mini_Order_Amt)),'') as miniOrderAmt,
            --//财务起订金额
            isnull(convert(varchar(23),convert(decimal(23,4),p.fi_Mini_Order_Amt)),'') as fiMiniOrderAmt ,
            --//不含运费单价的销售价格//up_def中bil_type=01
            isnull(convert(varchar(23),convert(decimal(23,4),u2.up)),'') as noTransUpSale,--//
           -- //含运费单价销售价格//up_def中bil_type!=01
           isnull(convert(varchar(23),convert(decimal(23,4),u1.up)),'') as haveTransUpSale,--//
            --//注意:采购只有本币
           -- //由于销售价格有本币和外币区别,所以加2个字段区分//然后上面2个作为本币销售
           -- //不含运费单价的销售价格外币
            isnull(convert(varchar(23),convert(decimal(23,4),u4.up)),'') as noTransUpSaleWaiBi,
            --//含运费单价销售价格外币//up_def中bil_type!=01
             isnull(convert(varchar(23),convert(decimal(23,4),u3.up)),'') as haveTransUpSaleWaiBi,
             --//主单位,由于2018_3_10   weekday(6)   19:34:05老郑让打样的excel中添加一个主单位
             isnull(p.main_Unit,isnull(u1.hj_no,'')) as mainUnit,  --prdt_samp里的主单位
             isnull(u1.hj_no,'') as unit,     --- 单位,来自up_def表
             isnull(convert(varchar(23),convert(decimal(23,4),u1.qty)),'') as qty,
            -- isnull(u1.prm_no,'') as prmNo,
            -- isnull(convert(varchar(23),convert(decimal(23,4),u5.qty)),isnull(convert(varchar(23),convert(decimal(23,4),u6.qty)),'')) as qty,
	      isnull(convert(varchar(23),DATEDIFF(S,'1970-01-01 00:00:00',convert(varchar(23),u1.s_dd,121)) - 8 * 3600)+'000','')as sDd
    </sql>

    <select id="getCountOfDuoTiaoJianChaXunZongJiLuShuExportExcel" resultType="java.lang.Integer">
        SELECT count(p.id)
        FROM PRDT_SAMP p
        <include refid="leftJoinOfExportExcel"/>
        WHERE
        <!-- 产品打样列表多条件查询的条件-->
        <include refid="exportExcelManyCondition"/>
    </select>

    <!-- =================================================================================================================== -->

    <select id="getUpDefMy" resultMap="UpDefMyBaseResultMap">
        Select
        top 20
        a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'') as dingJiaGuanLian--是页面四条数据保存的时候关联同一次的字段
        from up_def a
        LEFT JOIN prdt d ON d.prd_no=a.prd_no
        LEFT JOIN cur_id b ON a.cur_id=b.cur_id
        where
        a.prd_no=#{prdNo,jdbcType=VARCHAR}
        AND
        a.OLEFIELD like '%SamplesSys%'
        AND
        a.price_id=
        <choose>
            <when test="priceId != null and priceId != ''">
                #{priceId}
            </when>
            <otherwise>
                a.price_id
            </otherwise>
        </choose>
        ORDER BY
        a.s_dd DESC
    </select>


    <select id="getUpDefMy20180512Buy" resultMap="UpDefMyBaseResultMap">
        Select
        top 20
         a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'') as dingJiaGuanLian--是页面四条数据保存的时候关联同一次的字段
        from up_def a
        LEFT JOIN  prdt d ON d.prd_no=a.prd_no
        LEFT JOIN cur_id b ON a.cur_id=b.cur_id
        where
        a.prd_no=#{prdNo,jdbcType=VARCHAR}
        AND
        a.OLEFIELD like '%SamplesSys%'
        AND
        a.price_id= #{priceId}
        AND
        a.bil_type=#{bilType}
         GROUP BY
         a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'')

         ORDER BY
        a.s_dd DESC
    </select>


    <select id="getUpDefMy20180512BuyOne" resultMap="UpDefMyBaseResultMap">
        Select
        top 1
         a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'') as dingJiaGuanLian--是页面四条数据保存的时候关联同一次的字段
        from up_def a
        LEFT JOIN  prdt d ON d.prd_no=a.prd_no
        LEFT JOIN cur_id b ON a.cur_id=b.cur_id
        where
        a.prd_no=#{prdNo,jdbcType=VARCHAR}
        AND
        a.price_id= #{priceId}
        AND
        a.bil_type=#{bilType}
        and
        a.OLEFIELD=#{olefield}
        ORDER BY
        a.s_dd DESC
    </select>
    <resultMap id="UpDefMyBaseResultMap" type="com.winwin.picreport.Edto.UpDefMy01">
        <id column="CUR_ID" jdbcType="VARCHAR" property="curId"/>
        <id column="QTY" jdbcType="NUMERIC" property="qty"/>
        <id column="S_DD" jdbcType="TIMESTAMP" property="sDd"/>
        <result column="UP" jdbcType="NUMERIC" property="up"/>
        <result column="UNIT" jdbcType="VARCHAR" property="unit"/>
        <result column="name" jdbcType="VARCHAR" property="curName"/>
        <result column="bil_type" jdbcType="VARCHAR" property="bilType"/>
        <result column="price_id" jdbcType="VARCHAR" property="priceId"/>
        <result column="rem" jdbcType="VARCHAR" property="remOfPrdtSampOs"/>
        <result column="hj_no" jdbcType="VARCHAR" property="unit"/>
        <!-- <result column="ut" jdbcType="VARCHAR" property="unit" />-->
    </resultMap>

    <select id="getUpDefMy20180512Sale" resultMap="UpDefMyBaseResultMap">
        Select
        top 20
        a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'') as dingJiaGuanLian--是页面四条数据保存的时候关联同一次的字段
        from up_def a
        LEFT JOIN  prdt d ON d.prd_no=a.prd_no
        LEFT JOIN cur_id b ON a.cur_id=b.cur_id
        where
        a.prd_no=#{prdNo,jdbcType=VARCHAR}
        AND
        a.OLEFIELD like '%SamplesSys%'
                AND
                a.price_id=#{priceId}
                AND
                a.cur_id=#{CurId}
                AND
                a.bil_type=#{bilType}

        GROUP BY
         a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'')

         ORDER BY
        a.s_dd DESC
    </select>

    <!--  UpDefMy01 getUpDefMy20180512Saleone(@Param("prdNo")String prdNo,
        @Param("priceId")String priceId,
        @Param("bilType")String bilType,
        @Param("CurId")String CurId,
        @Param("olefield")String olefield);-->


    <select id="getUpDefMy20180512Saleone" resultMap="UpDefMyBaseResultMap">
        Select
        top 1 ----其实本来也只有一个
        a.s_dd --as sDd,---价格创建日期
        ,a.up --as up ,--价格
        ,a.qty --as qty ,--数量
        ,a.HJ_NO---单位
        ,a.cur_id ---as curId,----币别代号
        ,a.bil_type----01代表不含运费的单价
        ,a.rem---备注,打样系统的会存为"打样系统"
        ,a.price_id----1代表销售价格, 2代表采购价格
        ,b.name ----as curName ----币别名字
        --- ,isnull(a.OLEFIELD,'') as olefield---是页面四条数据保存的时候关联同一次的字段
        ,isnull(a.OLEFIELD,'') as dingJiaGuanLian--是页面四条数据保存的时候关联同一次的字段
        from up_def a
        LEFT JOIN prdt d ON d.prd_no=a.prd_no
        LEFT JOIN cur_id b ON a.cur_id=b.cur_id
        where
        a.prd_no=#{prdNo,jdbcType=VARCHAR}
        AND
        a.OLEFIELD=#{olefield}
        AND
        a.price_id=#{priceId}

        <if test="CurId != null and CurId != ''">
            AND a.cur_id = #{CurId} ---此时是本币
        </if>
        <if test="CurId != null and CurId == ''">
            AND a.cur_id != 'RMB'  --  此时是外币
        </if>
        AND
        a.bil_type=#{bilType}
        ORDER BY
        a.s_dd DESC
    </select>


    <select id="getPrdtSamp001" resultType="com.winwin.picreport.Bcontroller.daYang.DaYangExportExcel.DaoChu">
        select
        isnull(a.id,'') as id,
        isnull(a.prd_code,'') as prdCode,
        isnull(a.idx_name,'') as idxName,
        isnull(a.idx_no,'') as idxNo,
        isnull(a.fen_lei_no,'') as fenLeiNo,
        isnull(a.fen_lei_name,'') as fenLeiName,
        isnull(a.mark_name,'') as markName,
        isnull(a.mark_no,'') as markNo,
        isnull(a.colour,'')as colour,
        isnull(a.size,'') as size,
        isnull(a.sal_name,'') as salName,
        isnull(a.sal_No,'') as salNo,
        isnull(a.cus_no,'') as cusNo,
        isnull(a.cus_name,'') as cusName,
        isnull(a.isfenjie,'') as isfenjie,
        isnull(convert(varchar(36),a.samp_make,120),'') as sampMake,
        isnull(convert(varchar(36),a.samp_send,120),'') as sampSend,
        isnull(a.samp_requ,'') as sampRequ,
        isnull(a.samp_desc,'') as sampDesc,
        isnull(a.thum,'') as thum,
        isnull(a.attach,'') as attach,
        isnull(convert(varchar(36),a.insertdate,120),'') as insertdate,
        isnull(a.confirmman,'') as confirmman,
        isnull(a.confirmtimestr,'') as confirmtimestr,
        isnull(convert(varchar(2),a.isconfirm),'') as isconfirm,
        isnull(a.category,'')as category,
        isnull(a.teamname,'') as teamname,
        isnull(a.confirmrem,'')as confirmrem,
        isnull(a.unit,'') as unit,
        isnull(a.businessdesc,'')as businessdesc,
        isnull(a.financedesc,'') as financedesc ,
        isnull(convert(varchar(36),a.startsellcount),'')as startsellcount ,
        isnull(convert(varchar(36),a.modelcost),'')as modelcost,
        isnull(convert(varchar(36),a.estimateprice),'')as estimateprice,
        isnull(convert(varchar(36),a.littleorderprice),'')as littleorderprice,
        isnull(a.modelcostinvoiceno,'')as modelcostinvoiceno,
        isnull(convert(varchar(36),a.financestartsellcount),'')as financestartsellcount,
        isnull( convert(varchar(36),a.financemodelcost),'')as financemodelcost,
        isnull(convert(varchar(36),a.financelittleorderprice),'')as financelittleorderprice,
        isnull(a.buyerdesc,'')as buyerdesc,
        isnull(a.prd_No,'') as prdNo,
        isnull(a.salemandesc,'')salemandesc,
        isnull(convert(varchar(36),a.stopusedate,120),'')as stopusedate,
        isnull(a.cus_No_Give,'') as cusNoGive,
        isnull(a.cus_Name_Give,'') as cusNameGive,
        isnull(a.user_Name,'') as userName,
        isnull(a.tenant_Id,'') as tenantId,
        isnull(a.main_Unit,'') as mainUnit
        from prdt_samp a WHERE a.id IN
        <foreach item="item" index="index" collection="idList" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>


    <select id="getPrdtSamp002" resultType="com.winwin.picreport.Bcontroller.daYang.DaYangExportExcel.DaoChu">
        select
        top 1
        isnull(a.id,'') as id,
        isnull(a.prd_code,'') as prdCode,
        isnull(a.idx_name,'') as idxName,
        isnull(a.idx_no,'') as idxNo,
        isnull(a.fen_lei_no,'') as fenLeiNo,
        isnull(a.fen_lei_name,'') as  fenLeiName,
        isnull(a.mark_name,'') as markName,
        isnull(a.mark_no,'') as markNo,
        isnull(a.colour,'')as colour,
        isnull(a.size,'') as size,
        isnull(a.sal_name,'') as salName,
        isnull(a.sal_No,'') as salNo,
        isnull(a.cus_no,'') as cusNo,
        isnull(a.cus_name,'') as cusName,
        isnull(a.isfenjie,'') as isfenjie,
        isnull(convert(varchar(36),a.samp_make,120),'') as  sampMake,
        isnull(convert(varchar(36),a.samp_send,120),'')  as  sampSend,
        isnull(a.samp_requ,'') as sampRequ,
        isnull(a.samp_desc,'') as sampDesc,
        isnull(a.thum,'') as thum,
        isnull(a.attach,'') as attach,
        isnull(convert(varchar(36),a.insertdate,120),'') as insertdate,
        isnull(a.confirmman,'') as confirmman,
        isnull(a.confirmtimestr,'') as confirmtimestr,
        isnull(convert(varchar(2),a.isconfirm),'') as isconfirm,
        isnull(a.category,'')as category,
        isnull(a.teamname,'') as teamname,
        isnull(a.confirmrem,'')as confirmrem,
        isnull(a.unit,'') as unit,
        isnull(a.businessdesc,'')as businessdesc,
        isnull(a.financedesc,'') as financedesc ,
        isnull(convert(varchar(36),a.startsellcount),'')as startsellcount ,
        isnull(convert(varchar(36),a.modelcost),'')as modelcost,
        isnull(convert(varchar(36),a.estimateprice),'')as estimateprice,
        isnull(convert(varchar(36),a.littleorderprice),'')as littleorderprice,
        isnull(a.modelcostinvoiceno,'')as modelcostinvoiceno,
        isnull(convert(varchar(36),a.financestartsellcount),'')as financestartsellcount,
        isnull( convert(varchar(36),a.financemodelcost),'')as financemodelcost,
        isnull(convert(varchar(36),a.financelittleorderprice),'')as financelittleorderprice,
        isnull(a.buyerdesc,'')as buyerdesc,
        isnull(a.prd_No,'') as prdNo,
        isnull(a.salemandesc,'')salemandesc,
        isnull(convert(varchar(36),a.stopusedate,120),'')as stopusedate,
        isnull(a.cus_No_Give,'') as   cusNoGive,
        isnull(a.cus_Name_Give,'') as cusNameGive,
        isnull(a.user_Name,'') as userName,
        isnull(a.tenant_Id,'') as  tenantId,
        isnull(p.ut,isnull(a.main_Unit,'')) as mainUnit
        ,isnull(CONVERT(VARCHAR(33),u.up),'') as up
        ,isnull(x.nm_eng,'') as  nmEng
        FROM prdt_samp a
        LEFT JOIN PRDT p    ON   a.PRD_NO=p.PRD_NO
        LEFT JOIN UP_DEF u  ON   (a.prd_no=u.prd_no and u.bil_type=#{bilType} and u.cur_id=#{curId} and u.price_id=#{priceId})
        LEFT JOIN CUST x    ON    x.cus_no=a.cus_no
       where     id = #{id}
        order by u.s_dd desc
    </select>






    <select id="getIdUseConfirmTime" resultType="java.lang.String">
         SELECT
        -- top 500
        id FROM prdt_samp  --  限制最多导出500行
          <where>
              <include refid="productProofWithManyCondition"/>
          </where>

    </select>



    <select id="selectTop80OlefiledAndNoIn" resultType="java.lang.String">
        select a.olefield from
        (
           select top 80 olefield from
           up_def where
           prd_no=#{prdNo}
           and price_id=#{priceId}
           and olefield like #{olefield}
            <if test=" dingJiaGuanLiansNotIn !=null and dingJiaGuanLiansNotIn.size()>0 ">
                and olefield not in
                <foreach item="item" index="index" collection="dingJiaGuanLiansNotIn" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
           order by s_dd DESC
        ) a
        group by a.olefield
    </select>


    <update id="updateUpdef">
        update up_def
        <set>
           <if test=" remFrontAfter !=null and remFrontAfter!='' and remFrontAfter != 'null' ">
               rem =#{remFrontAfter},
           </if>
            <if test=" remFrontAfter == null or remFrontAfter == '' or remFrontAfter == 'null' ">
                rem =rem,
            </if>
            <if test=" qtyAfter !=null and qtyAfter !='' and qtyAfter != 'null' ">
                qty=#{qtyAfter},
            </if>

            <if test=" upAfter !=null and upAfter!='' and upAfter != 'null' ">
                up=#{upAfter},
            </if>

            <if test=" unitAfter !=null and unitAfter!='' and unitAfter != 'null' ">
                hj_no=#{unitAfter},
            </if>

        </set>
           where #{dingJiaZhuJian}=isnull(oleField,'')+isnull(bil_Type,'')+isnull(cur_id,'')+isnull(prd_no,'')
    </update>


    <select id="diGuiFenLeiName" resultType="java.lang.String">
        with cet1
        AS
        (
            -- 基本语句,
            select c.idx_no,c.idx_up,c.name from indx c where c.name = #{fenLeiName} -- 递归出来 idx_no=9 的所有下级

            union all
            --  递归语句
            select a.idx_no,a.idx_up,a.name from
            indx a
            inner join  cet1 b on a.idx_up=b.idx_no
        )
        select name as fenLeiName from cet1
    </select>

</mapper>


        <!--

                (
                insertDate
                BETWEEN
        <choose>
        <when test="insertdateStr != null and insertdateStr != ''">
            #{insertdateStr}
        </when>
        <otherwise>
            '1970-01-01'
        </otherwise>
        </choose>
                AND
        <choose>
        <when test="insertdateStrEnd != null and insertdateStrEnd != ''">
            #{insertdateStrEnd}
        </when>
        <otherwise>
            '9999-01-01'
        </otherwise>
        </choose>
                )
                AND
                (
                confirmTimeStr
                BETWEEN
        <choose>
        <when test="confirmtimestr != null and confirmtimestr != ''">
            #{confirmtimestr}
        </when>
        <otherwise>
            '1970-01-01'
        </otherwise>
        </choose>
                AND
        <choose>
        <when test="confirmtimestrEnd != null and confirmtimestrEnd != ''">
            #{confirmtimestrEnd}
        </when>
        <otherwise>
            '9999-01-01'
        </otherwise>
        </choose>
                )
                AND
                &#45;&#45;产品分类的name(小范围的,分类用最小分类),因为原来理解错了,所以现在反过来
                isnull(idx_Name,'') LIKE
        <choose>
        <when test="idxName != null and idxName != ''">
            ('%' + (#{idxName}) + '%')
        </when>
        <otherwise>
            isnull(idx_Name,'')
        </otherwise>
        </choose>
                AND
                -&#45;&#45;产品名称的name(大范围的,名称用的最大分类),因为原来理解错了,所以现在反过来
                isnull(fen_lei_name,'') LIKE
        <choose>
        <when test=" fenLeiName != null and fenLeiName != '' ">
            ('%'+( #{fenLeiName})+ '%')
        </when>
        <otherwise>
            isnull(fen_lei_name,'')
        </otherwise>
        </choose>
                AND
                &#45;&#45;产品编码
                isnull(prd_Code,'') LIKE
        <choose>
        <when test=" prdCode != null and prdCode != '' ">
            ('%'+( #{prdCode}) +'%')
        </when>
        <otherwise>
            isnull(prd_Code,'')
        </otherwise>
        </choose>

                AND
                &#45;&#45;产品负责人,模糊查询
                isnull(sal_name,'') LIKE
        <choose>
        <when test="salName != null and salName != '' ">
            ('%' +( #{salName}) + '%')
        </when>
        <otherwise>
            isnull(sal_name,'')
        </otherwise>
        </choose>
                AND
                &#45;&#45;是否已经打样确认，1是确认   0是未确认   ""确认+未确认
                isnull(isConfirm,9)=
        <choose>
        <when test=" isconfirm != null">
            #{isconfirm}
        </when>
        <otherwise>
            isnull(isConfirm,9)
        </otherwise>
        </choose>-->
